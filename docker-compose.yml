version: "3.2"
services:
  php-shntr:
    environment:
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID:-nokey}"
      AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY:-nosecret}"
      AWS_DEFAULT_REGION: "${AWS_DEFAULT_REGION:-noregion}"
      shntr_TOKEN_PASSPHRASE: "${shntr_TOKEN_PASSPHRASE:-nopassphrase}"
      shntr_TOKEN_USERNAME: "${shntr_TOKEN_USERNAME:-nousername}"
      shntr_TOKEN_PASSWORD: "${shntr_TOKEN_PASSWORD:-nopassword}"
      shntr_TOKEN_PAYMAIL: "${shntr_TOKEN_PAYMAIL:-nopaymail}"
    build:
      context: './php/'
      dockerfile: ${DOCKERFILE_NAME:-Dockerfile}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - backend-shntr
    volumes:
      - ./app:/var/www/html/
#      - ./php/xdebug.ini:/usr/local/etc/php/conf.d/xdebug.ini
  apache-shntr:
    build: './apache/'
    depends_on:
      - php-shntr
      - db-shntr
    networks:
      - frontend-shntr
      - backend-shntr
    ports:
      - "80:80"
    volumes:
      - ./app:/var/www/html/
  db-shntr:
    platform: linux/x86_64
    image: mariadb:10.6.4-focal
    networks:
      - backend-shntr
    volumes:
      - ./data:/var/lib/mysql/
      - ./mariadb:/tmp/mariadb
    ports:
      - 3307:3306
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_USER=shntrco_sngine
      - MYSQL_DATABASE=shntrco_sngine
      - MYSQL_PASSWORD=shntrco_sngine
    command: runuser -u mysql /tmp/mariadb/starter
  coin-svc:
    build: './coin-svc'
    ports:
    - 3001:3000
    networks:
      - backend-shntr
    volumes:
      - ~/.aws:/root/.aws
      - ./coin-svc/cache:/tmp/cache
      - ./coin-svc:/usr/app
    command: sh /usr/app/runner.sh
networks:
  frontend-shntr:
  backend-shntr:
